---
title: "Dynamic report"
output: pdf_document
params:
  yy: NA
  temp: NA
  main.title: NA
  fit: NA
  mod: NA
  modPoints: NA
  predPoints: NA
  alpha: NA
  dig: NA
  upper_shelf: NA
  lower_shelf: NA
  c_prov: NA
  d_prov: NA
  t0_prov: NA
  k_prov: NA
  m_prov: NA
  ck_prov: NA
  p_prov: NA
  dbtt: NA
---

<!-- This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>. -->

<!-- R code will have to go in "coding chunks" like the one below.  -->

<!-- I have commented out these remarks, but you can easily add text to the report by just typing.  -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r,echo=F}
############################
# specify title for analysis
main.title <<- params$main.title

#################################################
# Variable being fitted (KV = 1, LE = 2, SFA = 3)
fit <- params$fit

if (fit == 1) {
  main.title = paste(main.title,"KV",sep=" ")
  y.label = "Absorbed Energy KV, J"
}
if (fit == 2) {
  main.title = paste(main.title,"LE",sep=" ")
  y.label = "Lateral Expansion LE, mm"
}
if (fit == 3) {
  main.title = paste(main.title,"SFA",sep=" ")
  y.label = "Shear Fracture Appearance SFA, %"
}

##########################
# specify models to be fit
# ht : hyperbolic tangent
# htf : hyperbolic tangent with fixed shelves
# htuf:  hyperbolic tangent with fixed upper shelf
# aht : asymmetric hyperbolic tangent
# ahtf : asymmetric hyperbolic tangent with fixed shelves
# ahtuf : asymemtric hyperbolic tangent with fixed upper shelf
# abur : Burr distribution (asymmetric)
# aburf : Burr distribution (asymmetric - with fixed shelves)
# aburuf : Burr distribution (asymmetric with fixed upper shelf)
# koh : Kohout symmetric
# kohf : Kohout symmetric with fixed shelves
# kohuf : Kohout symmetric with fixed upper shelf
# akohf : Kohout asymmetric with fixed shelves
# akohuf : Kohout asymmetric with fixed upper shelf

mod = params$mod

########################
# Input data
temp = params$temp
yy = params$yy
nn = length(temp)

##############################
# prediction/confidence bounds
# prediction bounds are not available
# "c" = confidence bounds
# "p" = prediction bounds - not available
# "pc" = both - not available
# "no" = none
bnds = "c" ### TODO: add options for this in the app

########################
# input confidence level
alpha = params$alpha

###########################################################
# input number of temperatures for fitted curves and bounds
n.new = 20 ### TODO

#####################################
# input number of simulated data sets
nsim = 5000 ### TODO

#######################
# specify values for fixed shelves
upper_shelf = params$upper_shelf
lower_shelf = params$lower_shelf
# if (fit == 3) { ### TODO: Have this show up on the ui, or not be editable, when fit ==3
#   upper_shelf = 100
#   lower_shelf = 0
# }

#########################################################
# specify uncertainty of shelves for parametric bootstrap
# (simulations are needed to obtain the uncertainties of 
# the parameters when one or more shelves are fixed)
#
# uls = u(lower_shelf) will be converted to bounds of a 
# uniform distribution where the lower_shelf is bounded by [a, b]
# and a >= 0 (usually, a = 0)
# uls = (b - a)/sqrt(12)
# b = a + uls * sqrt(12)
#
# if fit ==3,
# uus = u(upper_shelf) will be converted to bounds of a 
# uniform distribution where the upper_shelf is bounded by [c, d] 
# and d <= 100 (usually, d = 100)
# uus = (d - c)/sqrt(12)
# c = d - uus*sqrt(12)
#
# if fit != 3, uus is normal(0,uus)

uls = 0.05
uus = upper_shelf*0.05

########################################
# specify starting values for each model

# hyperbolic tangent models
c_prov = params$c_prov
d_prov = params$d_prov
t0_prov = params$t0_prov

# burr models
k_prov = params$k_prov
m_prov = params$m_prov

# kohout models
ck_prov = params$ck_prov
p_prov = params$p_prov
dbtt = params$dbtt

start.ht    = c(c=c_prov, t0=t0_prov, lse=lower_shelf, use=upper_shelf)
start.htf   = c(c=c_prov, t0=t0_prov)
start.htuf  = c(c=c_prov, t0=t0_prov, lse=lower_shelf)

start.aht   = c(c=c_prov, t0=t0_prov, d=d_prov, lse=lower_shelf, use=upper_shelf)
start.ahtf  = c(c=c_prov, t0=t0_prov, d=d_prov)
start.ahtuf = c(c=c_prov, t0=t0_prov, d=d_prov, lse=lower_shelf)

start.abur   = c(k=k_prov, t0=t0_prov, m=m_prov, lse=lower_shelf, use=upper_shelf)
start.aburf  = c(k=k_prov, t0=t0_prov, m=m_prov) 
start.aburuf = c(k=k_prov, t0=t0_prov, m=m_prov, lse=lower_shelf) 

start.koh   = c(c=ck_prov, DBTT=t0_prov, lse=lower_shelf, use=upper_shelf)
start.kohf  = c(c=ck_prov, DBTT=t0_prov)
start.kohuf = c(c=ck_prov, DBTT=t0_prov, lse=lower_shelf)

start.akoh   = c(c=ck_prov, t0=dbtt, p=p_prov, lse=lower_shelf, use=upper_shelf )
start.akohf  = c(c=ck_prov, t0=dbtt, p=p_prov)
start.akohuf = c(c=ck_prov, t0=dbtt, p=p_prov, lse=lower_shelf)



############################################
# compute temperature for given response (y)
# will not compute uncertainty unless se(t0) 
# or se(DBTT) is "reasonable"
# yval = c(28,41) # Absorbed energy values of interest to nuclear community
# yval = 0.89   # Lateral expansion value of interest to nuclear community
if (fit == 3) {
  yval = 50
}

###########################
# specify options for plots
par(cex=1.25, lwd=1.25, cex.main=1)
dig<<-params$dig
colorz<<-c("red","blue","darkgreen","magenta","orange",
         "purple","brown","cyan","chartreuse")

############################################
# create new temperature values for plotting
tvals <<- seq(min(temp), max(temp), length.out=params$modPoints)
newt <<- data.frame(temp=tvals)
# names(newt) = c("temp")
##########################
# sort data by temperature
dft = data.frame(yy,temp)
dft = dft[order(dft$temp),]
temp <<- dft$temp
yy <<- dft$yy


###########################
# specify model information
ID <<- c("ht","htf","aht","ahtf","abur","aburf","koh","kohf","akohf")
titles <<- c("Symmetric TANH",   "Symmetric TANH, Fixed Shelves",
          "Asymmetric TANH",  "Asymmetric TANH, Fixed Shelves",
          "Burr Distribution",  "Burr Distribution, Fixed Shelves",
          "Symmetric Kohout", "Symmetric Kohout, Fixed Shelves",
                         "Asymmetric Kohout, Fixed Shelves")
nmod <<- length(ID)
num <<-c(1:nmod)
dfmod <<- data.frame(num,ID,titles)

##############################
# fit and plot selected models
mstats = fits(mod)
plot.mods(mod)


for(i in mod){
  resname = paste("r",i,sep="")
  res = get(resname)
  splot(i, res)
#  plot4(i, res)
  nlsres(i, res)
  rplot(i, res)
  if (i=="akohf") bnds = "n"
  if (bnds == "c"){
    pcplot(i, res, "c")
  } else if (bnds == "p") {
    pcplot(i, res, "p")
  } else if (bnds == "pc") {
    pcplot(i, res, "c")
    pcplot(i, res, "p")
  }
}

#####################################
# close output file containing graphs
# dev.off()

#####################################
# Write analysis results in text file
dash = "================================================================= "
# sink(outfile)
cat(main.title, "\n")
cat("Model Selection Statistics", "\n")
mstats

for(i in mod){
  resname = paste("r",i,sep="")
  res = get(resname)
  cat(dash, "\n")
  head = as.character(dfmod[dfmod$ID==i,]$titles)
  cat(head, "\n")
  print(summary(res))
  if (i != "akohf") print(tfun(i,res,yval))
}
# sink()

# beep(3)


```